{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "artifactsBaseUrl": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/Codeum/AzureElasticTemplate/master/src",
      "metadata": {
        "artifactsBaseUrl": "Base URL of the Elastic template gallery package"
      }
    },
    "esVersion": {
      "type": "string",
      "defaultValue": "6.2.2",
      "allowedValues": [
        "6.2.1",
        "6.2.2"
      ],
      "metadata": {
        "description": "Elasticsearch version to install"
      }
    },
    "esEnableAnonymousAccess": {
      "type": "string",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "defaultValue": "No",
      "metadata": {
        "description": "Enable Anonymous Access"
      }
    },
    "esClusterName": {
      "type": "string",
      "defaultValue": "elasticsearch",
      "metadata": {
        "description": "The name of the Elasticsearch cluster"
      }
    },
    "loadBalancerType": {
      "type": "string",
      "defaultValue": "internal",
      "allowedValues": [
        "internal",
        "external",
        "gateway"
      ],
      "metadata": {
        "description": "Set up an internal or external load balancer, or use Application Gateway (gateway) for load balancing and SSL offload. If you are setting up Elasticsearch on a publicly available endpoint, it is *strongly recommended* to secure your nodes with a product like Elastic's X-Pack Security"
      }
    },
    "xpackPlugins": {
      "type": "string",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "defaultValue": "Yes",
      "metadata": {
        "description": "Install the Commercial X-Pack Plugins - Monitoring, Security, Alerting, Graph* (Elasticsearch 2.3.0+), Machine Learning* (Elasticsearch 5.5.0+), and if installing Kibana, Reporting and Profiler"
      }
    },
    "esAdditionalPlugins": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Additional Elasticsearch plugins to install.  Each plugin must be separated by a semicolon. e.g. analysis-icu;mapper-attachments"
      }
    },
    "esAdditionalYaml": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Additional configuration for Elasticsearch yaml configuration file. Each line must be separated by a newline character e.g. action.auto_create_index: .security\nindices.queries.cache.size:5%"
      }
    },
    "esHeapSize": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The size, in megabytes, of memory to allocate on each Elasticsearch node for the JVM heap. If unspecified, 50% of the available memory will be allocated to Elasticsearch heap, up to a maximum of 31744MB (~32GB)."
      }
    },
    "kibana": {
      "type": "string",
      "defaultValue": "Yes",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Provision a machine with Kibana on it"
      }
    },
    "vmSizeKibana": {
      "type": "string",
      "defaultValue": "Standard_A2",
      "metadata": {
        "description": "Size of the Kibana node"
      }
    },
    "kibanaCertBlob": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "A Base-64 encoded form of the certificate (.crt) to secure HTTPS communications between the browser and Kibana."
      }
    },
    "kibanaKeyBlob": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "A Base-64 encoded form of the private key (.key) to secure HTTPS communications between the browser and Kibana."
      }
    },
    "kibanaKeyPassphrase": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The passphrase to decrypt the private key. Optional as the key may not be encrypted. Supported only in 5.3.0+"
      }
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "es-",
      "metadata": {
        "description": "The prefix to use for hostnames when naming virtual machines in the cluster. Can be up to 5 characters in length, must begin with an alphanumeric character and can contain alphanumeric and hyphen characters. Hostnames are used for resolution of master nodes so if you are deploying a cluster into an existing virtual network containing an existing Elasticsearch cluster, be sure to set this to a unique prefix to differentiate the hostnames of this cluster from an existing cluster"
      }
    },
    "vmSizeDataNodes": {
      "type": "string",
      "defaultValue": "Standard_D1",
      "metadata": {
        "description": "Size of the Elasticsearch data nodes"
      }
    },
    "vmDataDiskCount": {
      "type": "int",
      "defaultValue": 40,
      "allowedValues": [
        0,
        1,
        2,
        4,
        8,
        16,
        32,
        40
      ],
      "metadata": {
        "description": "Number of disks to attach to each data node in RAID 0 setup. If the number of disks selected is more than can be attached to the data node VM size, the maximum number of disks that can be attached will be used. If 1 disk is selected, it is not RAIDed. If 0 disks are selected, the temporary disk will be used to store Elasticsearch data. IMPORTANT: The temporary disk is ephemeral in nature so be sure you know the trade-offs when choosing 0 disks."
      }
    },
    "vmDataDiskSize": {
      "type": "string",
      "defaultValue": "Large",
      "allowedValues": [
        "Small",
        "Medium",
        "Large"
      ],
      "metadata": {
        "description": "The disk size of each attached disk, Small (128Gb), Medium (512Gb) or Large (1024Gb). For Premium Storage, this equates to P10, P20 and P30, respectively."
      }
    },
    "vmDataNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "metadata": {
        "description": "Number of Elasticsearch data nodes"
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Default",
      "allowedValues": [
        "Default",
        "Standard"
      ],
      "metadata": {
        "description": "The storage account type of the attached disks (Default or Standard). The Default storage account type will be Premium Storage for VMs that support Premium Storage and Standard Storage for those that do not."
      }
    },
    "dataNodesAreMasterEligible": {
      "type": "string",
      "defaultValue": "No",
      "allowedValues": [
        "Yes",
        "No"
      ],
      "metadata": {
        "description": "Make all data nodes master-eligible. This can be useful for small elasticsearch cluster deployments, but for larger deployments it is recommended to use dedicated master nodes"
      }
    },
    "vmSizeMasterNodes": {
      "type": "string",
      "defaultValue": "Standard_D1",
      "metadata": {
        "description": "Size of the Elasticsearch master nodes, if data nodes are not master eligible, 3 master nodes of this size will be provisioned"
      }
    },
    "vmClientNodeCount": {
      "type": "int",
      "defaultValue": 0,
      "minValue": 0,
      "metadata": {
        "description": "Number of Elasticsearch client nodes to provision. A value of 0 puts the data nodes on the load balancer"
      }
    },
    "vmSizeClientNodes": {
      "type": "string",
      "defaultValue": "Standard_D1",
      "metadata": {
        "description": "Size of the Elasticsearch client nodes"
      }
    },
    "adminUsername": {
      "type": "string",
      "metadata": {
        "description": "Admin username used when provisioning virtual machines"
      }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "password",
        "sshPublicKey"
      ],
      "metadata": {
        "description": "Choose a password or ssh public key for the Admin username used to access virtual machines"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Admin password"
      }
    },
    "sshPublicKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Admin ssh public key"
      }
    },
    "securityBootstrapPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the bootstrap.password to add to the keystore in 6.x. If no value is supplied, a 13 character password will be generated using the uniqueString() function"
      }
    },
    "securityAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the superuser 'es_admin' in 2.x, or 'elastic' user in 5.x and up. Must be > 6 characters"
      }
    },
    "securityReadPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the 'es_read' user with user (read-only) role. Must be > 6 characters"
      }
    },
    "securityKibanaPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the 'es_kibana' user with kibana4_server role in 2.x, or 'kibana' user in 5.x and up. Must be > 6 characters"
      }
    },
    "securityLogstashPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the 'logstash_system' user in 5.2.0 and up. Must be > 6 characters"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location where resources will be provisioned. By default, the template deploys the resources to the same location as the resource group. If specified, must be a valid Azure location e.g. 'australiasoutheast'"
      }
    },
    "vNetName": {
      "type": "string",
      "defaultValue": "es-vnet",
      "metadata": {
        "description": "Virtual Network Name"
      }
    },
    "vNetResourceGroup": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the resource group for the existing Virtual Network. Required when using an existing Virtual Network"
      }
    },
    "vNetLoadBalancerIp": {
      "type": "string",
      "defaultValue": "10.0.0.4",
      "metadata": {
        "description": "The static IP address for the internal load balancer. This must be an available IP address in the specified subnet"
      }
    },
    "vNetClusterSubnetName": {
      "type": "string",
      "defaultValue": "es",
      "metadata": {
        "description": "Subnet name to use for Elasticsearch nodes"
      }
    }
  },
  "variables": {
    "createCluster": "[greater(parameters('vmDataNodeCount'), 1)]",
    "emptyArray": [],
    "templateBaseUrl": "[concat(parameters('artifactsBaseUrl'), '/')]",
    "loadBalancerOptions": {
      "internal": "internal-lb-resources",
      "external": "external-lb-resources"
    },
    "loadBalancerTemplateUrl": "[concat(variables('templateBaseUrl'), 'loadbalancers/', variables('loadBalancerOptions')[parameters('loadBalancerType')],'.json')]",
    "osSettingsTemplateUrl": "[concat(variables('templateBaseUrl'), 'settings/ubuntuSettings.json')]",
    "location": "[parameters('location')]",
    "esToKibanaMapping": {
      "6.2.1": "6.2.1",
      "6.2.2": "6.2.2"
    },
    "esSettings": {
      "clusterName": "[parameters('esClusterName')]",
      "version": "[parameters('esVersion')]",
      "installPlugins": "[parameters('xpackPlugins')]",
      "installAdditionalPlugins": "[parameters('esAdditionalPlugins')]",
      "yamlConfiguration": "[parameters('esAdditionalYaml')]",
      "heapSize": "[parameters('esHeapSize')]",
      "securityAdminPwd": "[parameters('securityAdminPassword')]",
      "securityReadPwd": "[parameters('securityReadPassword')]",
      "securityKibanaPwd": "[parameters('securityKibanaPassword')]",
      "securityLogstashPwd": "[parameters('securityLogstashPassword')]",
      "securityBootstrapPwd": "[if(not(empty(parameters('securityBootstrapPassword'))),parameters('securityBootstrapPassword'),uniqueString(resourceGroup().id, deployment().name, parameters('securityAdminPassword')))]",
      "kibanaVersion": "[variables('esToKibanaMapping')[parameters('esVersion')]]"
    },
    "dataSkuSettings": {
      "Standard_A0": {
        "dataDisks": 1,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A1": {
        "dataDisks": 2,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A2": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A3": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A4": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A5": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A6": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_A7": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D1": {
        "dataDisks": 2,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D2": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D3": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D4": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D11": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D12": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D13": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D14": {
        "dataDisks": 32,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D1_v2": {
        "dataDisks": 2,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D2_v2": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D3_v2": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D4_v2": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D5_v2": {
        "dataDisks": 32,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D11_v2": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D12_v2": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D13_v2": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D14_v2": {
        "dataDisks": 32,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D15_v2": {
        "dataDisks": 40,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_D2S_v3": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_B2S": {
        "dataDisks": 2,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS1": {
        "dataDisks": 2,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS2": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS3": {
        "dataDisks": 8,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS4": {
        "dataDisks": 16,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS11": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS12": {
        "dataDisks": 8,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS13": {
        "dataDisks": 16,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS14": {
        "dataDisks": 32,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS1_v2": {
        "dataDisks": 2,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS2_v2": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS3_v2": {
        "dataDisks": 8,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS4_v2": {
        "dataDisks": 16,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS5_v2": {
        "dataDisks": 32,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS11_v2": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS12_v2": {
        "dataDisks": 8,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS13_v2": {
        "dataDisks": 16,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS14_v2": {
        "dataDisks": 32,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_DS15_v2": {
        "dataDisks": 40,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_F1": {
        "dataDisks": 2,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_F2": {
        "dataDisks": 4,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_F4": {
        "dataDisks": 8,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_F8": {
        "dataDisks": 16,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_F16": {
        "dataDisks": 32,
        "storageAccountType": "Standard_LRS"
      },
      "Standard_F1s": {
        "dataDisks": 2,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_F2s": {
        "dataDisks": 4,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_F4s": {
        "dataDisks": 8,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_F8s": {
        "dataDisks": 16,
        "storageAccountType": "Premium_LRS"
      },
      "Standard_F16s": {
        "dataDisks": 32,
        "storageAccountType": "Premium_LRS"
      }
    },
    "dataDiskSizes": {
      "Large": 1023,
      "Medium": 512,
      "Small": 128
    },
    "backendPoolConfigurations": {
      "internal": [
        {
          "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(parameters('namePrefix'), 'int-lb')),'/backendAddressPools/LBBE')]"
        }
      ],
      "external": [
        {
          "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(parameters('namePrefix'), 'int-lb')),'/backendAddressPools/LBBE')]"
        },
        {
          "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(parameters('namePrefix'), 'ext-lb')),'/backendAddressPools/LBBE')]"
        }
      ],
      "gateway": [
        {
          "id": "[concat(resourceId('Microsoft.Network/loadBalancers', concat(parameters('namePrefix'), 'int-lb')),'/backendAddressPools/LBBE')]"
        }
      ]
    },
    "lbBackEndPoolsAdded": {
      "backendPools": "[variables('backendPoolConfigurations')[parameters('loadBalancerType')]]"
    },
    "lbBackendPoolsRemoved": {
      "backendPools": []
    },
    "dataLoadBalancerOptions": [
      "[variables('lbBackEndPoolsAdded')]",
      "[variables('lbBackEndPoolsRemoved')]"
    ],
    "clientResourceIndex": "[mod(add(parameters('vmClientNodeCount'),2),add(parameters('vmClientNodeCount'),1))]",
    "nodesPerStorageMapping": {
      "Standard_LRS_Small_1": 40,
      "Standard_LRS_Small_2": 20,
      "Standard_LRS_Small_4": 10,
      "Standard_LRS_Small_8": 5,
      "Standard_LRS_Small_16": 2,
      "Standard_LRS_Small_32": 1,
      "Standard_LRS_Small_40": 1,
      "Standard_LRS_Small_0": 0,
      "Standard_LRS_Medium_1": 40,
      "Standard_LRS_Medium_2": 20,
      "Standard_LRS_Medium_4": 10,
      "Standard_LRS_Medium_8": 5,
      "Standard_LRS_Medium_16": 2,
      "Standard_LRS_Medium_32": 1,
      "Standard_LRS_Medium_40": 1,
      "Standard_LRS_Medium_0": 0,
      "Standard_LRS_Large_1": 40,
      "Standard_LRS_Large_2": 20,
      "Standard_LRS_Large_4": 10,
      "Standard_LRS_Large_8": 5,
      "Standard_LRS_Large_16": 2,
      "Standard_LRS_Large_32": 1,
      "Standard_LRS_Large_40": 1,
      "Standard_LRS_Large_0": 0,
      "Premium_LRS_Small_1": 250,
      "Premium_LRS_Small_2": 125,
      "Premium_LRS_Small_4": 62,
      "Premium_LRS_Small_8": 31,
      "Premium_LRS_Small_16": 15,
      "Premium_LRS_Small_32": 7,
      "Premium_LRS_Small_40": 6,
      "Premium_LRS_Small_0": 0,
      "Premium_LRS_Medium_1": 60,
      "Premium_LRS_Medium_2": 30,
      "Premium_LRS_Medium_4": 15,
      "Premium_LRS_Medium_8": 7,
      "Premium_LRS_Medium_16": 3,
      "Premium_LRS_Medium_32": 1,
      "Premium_LRS_Medium_40": 1,
      "Premium_LRS_Medium_0": 0,
      "Premium_LRS_Large_1": 34,
      "Premium_LRS_Large_2": 17,
      "Premium_LRS_Large_4": 8,
      "Premium_LRS_Large_8": 4,
      "Premium_LRS_Large_16": 2,
      "Premium_LRS_Large_32": 1,
      "Premium_LRS_Large_40": 1,
      "Premium_LRS_Large_0": 0
    },
    "storageAccountOverrides": {
      "Default": "[variables('dataSkuSettings')[parameters('vmSizeDataNodes')].storageAccountType]",
      "Standard": "Standard_LRS",
      "Premium": "Premium_LRS"
    },
    "resolvedStorageAccountType": "[variables('storageAccountOverrides')[parameters('storageAccountType')]]",
    "tmpVmSizeDataDisks": "[variables('dataSkuSettings')[parameters('vmSizeDataNodes')].dataDisks]",
    "dataDiskOptions": [
      "[parameters('vmDataDiskCount')]",
      "[variables('tmpVmSizeDataDisks')]"
    ],
    "smallestDataDiskOption": "[min(variables('dataDiskOptions'))]",
    "numberOfDataDisks": "[div(add(add(0, variables('smallestDataDiskOption')), int(replace(string(sub(0, variables('smallestDataDiskOption'))), '-', ''))), 2)]",
    "nodesPerStorageAccount": "[variables('nodesPerStorageMapping')[concat(variables('resolvedStorageAccountType'), '_', parameters('vmDataDiskSize'), '_', string(variables('numberOfDataDisks')))]]",
    "nodesPerStorageAccountDiv": "[div(add(add(1, variables('nodesPerStorageAccount')), int(replace(string(sub(1, variables('nodesPerStorageAccount'))), '-', ''))), 2)]",
    "storageAccountsCount": "[add(div(parameters('vmDataNodeCount'), variables('nodesPerStorageAccountDiv')), mod(add(mod(parameters('vmDataNodeCount'), variables('nodesPerStorageAccountDiv')),2), add(mod(parameters('vmDataNodeCount'), variables('nodesPerStorageAccountDiv')),1)))]",
    "kibanaHttps": "[if(and(greater(length(parameters('kibanaKeyBlob')), 0), greater(length(parameters('kibanaCertBlob')), 0)), 'Yes', 'No')]",
    "topologySettings": {
      "namespacePrefix": "[parameters('namePrefix')]",
      "dataNodesAreMasterEligible": "[parameters('dataNodesAreMasterEligible')]",
      "vmDataNodeCount": "[parameters('vmDataNodeCount')]",
      "vmSizeDataNodes": "[parameters('vmSizeDataNodes')]",
      "vmClientNodeCount": "[parameters('vmClientNodeCount')]",
      "vmSizeClientNodes": "[parameters('vmSizeClientNodes')]",
      "vNetLoadBalancerIp": "[parameters('vNetLoadBalancerIp')]",
      "vmSizeMasterNodes": "[parameters('vmSizeMasterNodes')]",
      "vmSizeKibana": "[parameters('vmSizeKibana')]",
      "kibana": "[parameters('kibana')]",
      "kibanaKeyBlob": "[parameters('kibanaKeyBlob')]",
      "kibanaKeyPassphrase": "[parameters('kibanaKeyPassphrase')]",
      "kibanaCertBlob": "[parameters('kibanaCertBlob')]",
      "kibanaHttps": "[variables('kibanaHttps')]",
      "dataNodeStorageSettings": {
        "count": "[variables('storageAccountsCount')]",
        "nodesPerStorageAccount": "[variables('nodesPerStorageAccount')]",
        "accountType": "[variables('resolvedStorageAccountType')]",
        "diskSize": "[variables('dataDiskSizes')[parameters('vmDataDiskSize')]]",
        "dataDisks": "[variables('numberOfDataDisks')]"
      },
      "dataLoadBalancerBackEndPools": "[if(variables('createCluster'), variables('dataLoadBalancerOptions')[variables('clientResourceIndex')].backendPools, variables('emptyArray'))]",
      "loadBalancerBackEndPools": "[if(variables('createCluster'), variables('lbBackEndPoolsAdded').backendPools, variables('emptyArray'))]",
      "enableAnonymousAccess": "[parameters('esEnableAnonymousAccess')]"
    },
    "networkSettings": {
      "namespacePrefix": "[parameters('namePrefix')]",
      "name": "[parameters('vNetName')]",
      "resourceGroup": "[parameters('vNetResourceGroup')]",
      "location": "[variables('location')]",
      "subnet": {
        "name": "[parameters('vNetClusterSubnetName')]",
        "loadbalancerIp": "[parameters('vNetLoadBalancerIp')]"
      }
    },
    "commonVmSettings": {
      "createCluster": "[variables('createCluster')]",
      "namespacePrefix": "[parameters('namePrefix')]",
      "location": "[variables('location')]",
      "subnet": "[variables('networkSettings').subnet]",
      "subnetId": "[concat(resourceId(variables('networkSettings').resourceGroup, 'Microsoft.Network/virtualNetworks', variables('networkSettings').name), '/subnets/', variables('networkSettings').subnet.name)]",
      "credentials": {
        "adminUsername": "[parameters('adminUsername')]",
        "password": "[parameters('adminPassword')]",
        "authenticationType": "[parameters('authenticationType')]",
        "sshPublicKey": "[parameters('sshPublicKey')]"
      }
    }
  },
  "resources": [
    {
      "condition": "[variables('createCluster')]",
      "name": "loadbalancer",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'network')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('loadBalancerTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "networkSettings": {
            "value": "[variables('networkSettings')]"
          },
          "applicationGatewaySettings": {
            "value": "[variables('applicationGatewaySettings')]"
          }
        }
      }
    },
    {
      "condition": "[variables('createCluster')]",
      "name": "virtual-machines-cluter",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'loadbalancer')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('osSettingsTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "templateBaseUrl": {
            "value": "[variables('templateBaseUrl')]"
          },
          "esSettings": {
            "value": "[variables('esSettings')]"
          },
          "commonVmSettings": {
            "value": "[variables('commonVmSettings')]"
          },
          "topologySettings": {
            "value": "[variables('topologySettings')]"
          },
          "networkSettings": {
            "value": "[variables('networkSettings')]"
          }
        }
      }
    },
    {
      "condition": "[not(variables('createCluster'))]",
      "apiVersion": "2016-03-30",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(parameters('namePrefix'), 'data-vm0-nic')]",
      "location": "[variables('commonVmSettings').location]",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'network')]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "PrivateIpAddress": "[variables('topologySettings').vNetLoadBalancerIp]",
              "privateIPAllocationMethod": "Static",
              "subnet": {
                "id": "[variables('commonVmSettings').subnetId]"
              },
              "loadBalancerBackendAddressPools": "[variables('topologySettings').dataLoadBalancerBackEndPools]"
            }
          }
        ]
      }
    },
    {
      "condition": "[not(variables('createCluster'))]",
      "name": "virtual-machines",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-02-01",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', parameters('namePrefix'), 'data-vm0-nic')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('osSettingsTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "templateBaseUrl": {
            "value": "[variables('templateBaseUrl')]"
          },
          "esSettings": {
            "value": "[variables('esSettings')]"
          },
          "commonVmSettings": {
            "value": "[variables('commonVmSettings')]"
          },
          "topologySettings": {
            "value": "[variables('topologySettings')]"
          },
          "networkSettings": {
            "value": "[variables('networkSettings')]"
          }
        }
      }
    }
  ]
}
